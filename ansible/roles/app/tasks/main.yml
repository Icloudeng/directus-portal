---
# tasks file for ansible/roles/app
- name: App Repository | Clone
  become: false
  git:
    repo: "{{ app_git_repo }}"
    dest: "{{ root_path }}"
    force: yes
    version: "{{ app_git_version }}"

- name: PNPM | Setup
  become: false
  command: pnpm setup
  args:
    chdir: "{{ root_path }}"
  ignore_errors: true

- name: App Client | Download client dependencies
  become: false
  command: pnpm install
  args:
    chdir: "{{ root_path }}"

- include_tasks: cms-config.yml
- include_tasks: web-config.yml
- include_tasks: docs-config.yml
  when: has_docs_app

# Project Build
- name: "Web App (Project Build) | delete .next folder"
  command: "rm -rf .next/"
  args:
    chdir: "{{ root_path }}/apps/web"

- name: Project Build | Build all app packages (execpt docs)
  become: false
  command: pnpm run build --filter=!docs # Ingore docs, the docs-generator will build it
  args:
    chdir: "{{ root_path }}"

# CMS App
- name: CMS App | App bootstrap
  become: false
  command: pnpm run bootstrap
  args:
    chdir: "{{ root_path }}/apps/cms"

- name: CMS App | App apply snapshot
  become: false
  command: pnpm run apply
  args:
    chdir: "{{ root_path }}/apps/cms"
    removes: "{{ root_path }}/apps/cms/snapshot.yaml"

- name: CMS App | Create App User
  become: false
  command: "node create-app-user.js"
  args:
    chdir: "{{ root_path }}/apps/cms"

# CMS App PM2 restart process
- name: CMS App | Delete old pm2 process
  command: "pm2 delete {{ cms_domain }}"
  args:
    chdir: "{{ root_path }}/apps/cms"
  ignore_errors: true

- name: CMS App | Start the server
  command: "pm2 start npm --name {{ cms_domain }} -- run start"
  args:
    chdir: "{{ root_path }}/apps/cms"

# Web App PM2 restart process
- name: Web App | Delete old pm2 process
  command: "pm2 delete {{ domain }}"
  args:
    chdir: "{{ root_path }}/apps/web"
  ignore_errors: true

- name: Web App | Start the server
  command: "pm2 start npm --name {{ domain }} -- run start"
  args:
    chdir: "{{ root_path }}/apps/web"

# Docs App PM2 Name fact (It should set before docs generator)
- name: DOCS | PM2 Name
  set_fact:
    docs_pm2_name: "{{ domain }}-docs"

# Docs generator config (It should come of CMS)
- include_tasks: docs-generator.yml
  when: has_docs_app

# Docs App PM2 restart process (It should come of DOCS generator)
- name: DOCS | Build docs app
  become: false
  command: pnpm run build --filter=docs # Build only docs app from workspace
  args:
    chdir: "{{ root_path }}"
  ignore_errors: true

- name: Docs App | Delete old pm2 process
  command: "pm2 delete {{ docs_pm2_name }}"
  args:
    chdir: "{{ root_path }}/apps/docs"
  ignore_errors: true
  when: has_docs_app

- name: Docs App | Start the server
  command: "pm2 start npm --name {{ docs_pm2_name }} -- run serve"
  args:
    chdir: "{{ root_path }}/apps/docs"
  when: has_docs_app

# Gerate pm2 scripts
- name: PM2 | Generating a Startup Script
  command: "pm2 startup"

- name: PM2 | Save the app list to be restored at reboot
  command: "pm2 save"

- name: Reload nginx
  service:
    name: nginx
    state: reloaded
  ignore_errors: true

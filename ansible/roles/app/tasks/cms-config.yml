- name: App CMS .env config
  set_fact:
    env_file: "{{ root_path }}/apps/cms/.env"

- name: App CMS .env config | PUBLIC_URL (letsencrypt == true)
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^PUBLIC_URL="
    line: 'PUBLIC_URL="https://{{ admin_domain }}/"'
  when: letsencrypt == true

- name: App CMS .env config | PUBLIC_URL (letsencrypt == false)
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^PUBLIC_URL="
    line: 'PUBLIC_URL="http://{{ admin_domain }}/"'
  when: letsencrypt == false

- name: App CMS .env config | ADMIN_EMAIL
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^ADMIN_EMAIL="
    line: "ADMIN_EMAIL={{ portaladmin_email }}"

- name: App CMS .env config | ADMIN_PASSWORD
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^ADMIN_PASSWORD="
    line: "ADMIN_PASSWORD={{ portaladmin_password }}"

- name: App CMS .env config | APP_USER_EMAIL
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^APP_USER_EMAIL="
    line: "APP_USER_EMAIL={{ appuser_email }}"

- name: App CMS .env config | APP_USER_PASSWORD
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^APP_USER_PASSWORD="
    line: "APP_USER_PASSWORD={{ portaladmin_password }}"

- name: App CMS .env config | APP_USER_TOKEN
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^APP_USER_TOKEN="
    line: "APP_USER_TOKEN={{ app_user_token }}"

- name: App CMS .env config | DB_DATABASE
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^DB_DATABASE="
    line: "DB_DATABASE={{ database }}"

- name: App CMS .env config | DB_USER
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^DB_USER="
    line: "DB_USER={{ database }}"

- name: App CMS .env config | DB_PASSWORD
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^DB_PASSWORD="
    line: "DB_PASSWORD={{ database_password }}"

- name: App CMS .env config | CACHE_ENABLED
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^CACHE_ENABLED="
    line: "CACHE_ENABLED=true"

- name: App CMS .env config | RATE_LIMITER_ENABLED
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^RATE_LIMITER_ENABLED="
    line: "RATE_LIMITER_ENABLED=false"

- name: App CMS .env config | RATE_LIMITER_STORE
  lineinfile:
    path: "{{ env_file }}"
    regexp: "^RATE_LIMITER_STORE="
    line: "RATE_LIMITER_STORE=redis"

- name: App CMS .env config | Redis
  blockinfile:
    path: "{{ env_file }}"
    insertafter: "CACHE_ENABLED=true"
    block: |
      CACHE_STORE=redis
      CACHE_REDIS_HOST=127.0.0.1
      CACHE_REDIS_PORT=6379
      # Messenger
      MESSENGER_STORE=redis
      # Rate Limiter
      RATE_LIMITER_REDIS_HOST=127.0.0.1
      RATE_LIMITER_REDIS_PORT=6379
      # Cors
      CORS_ENABLED=false
      CORS_ORIGIN="array:http://localhost,http://127.0.0.1,https://{{ admin_domain }}"
      CORS_METHODS=GET,POST,PATCH,DELETE
      CORS_ALLOWED_HEADERS=Content-Type,Authorization
      CORS_EXPOSED_HEADERS=Content-Range
      CORS_CREDENTIALS=false
      CORS_MAX_AGE=18000
    state: present
